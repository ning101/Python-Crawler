import re
import pymysql
import requests
import time
from urllib import robotparser
from urllib import request
from urllib.parse import urljoin
from bs4 import BeautifulSoup

#json分类信息，f12直接复制的，难得爬
ary_base_market = [[13075,'黄瓜',20410],[13080,'活草鱼',8754711],[13079,'鸡蛋',13245],[13077,'玫瑰(月季)',13279],[13073,'面粉',13095],[13076,'香蕉',13103],[13080,'白鲢活鱼',8754710],[13076,'富士苹果',13097],[13077,'菊花',13280],[13073,'绿豆',13096],[13075,'西红柿',20414],[13079,'猪肉(白条猪)',13233],[13075,'大白菜',20409],[13080,'活鲫鱼',8754722],[13077,'康乃磬',13282],[13079,'内三元母猪',16027054],[13079,'内三元生猪',16027050],[13079,'内三元仔猪',16027052],[13079,'牛肉',13235],[13073,'色拉油',13119],[13079,'外三元母猪',16027055],[13079,'外三元生猪',16027051],[13079,'外三元仔猪',16027053],[13076,'西瓜',13106],[13073,'大豆',13087],[13076,'哈密瓜',13107],[13080,'活鲤鱼',8754705],[13077,'唐昌蒲(剑兰)',13284],[13075,'土豆',20413],[13079,'羊肉',13237],[13079,'白条鸡',13240],[13076,'菠萝',13105],[13077,'东方百合',13288],[13080,'黄鳝',13137],[13075,'芹菜',20411],[13073,'一级豆油(散装)',8754698],[13076,'伽师瓜',15002880],[13073,'红小豆',13099],[13076,'巨峰葡萄',13139],[13075,'青椒',13811],[13080,'武昌鱼',13144],[13079,'鸭蛋',13248],[13077,'亚洲百合',13292],[13080,'带鱼',13118],[13079,'活鸡',13243],[13073,'粳米(普通)',8754673],[13075,'韭菜',13515],[13076,'蜜桔',13098],[13077,'麝香百合',13295],[13073,'菜油(散装)',8754689],[13077,'非洲菊(扶郎花)',13299],[13080,'黑鱼',13134],[13075,'茄子',13509],[13079,'乌鸡',13257],[13076,'鸭梨',13102],[13073,'标准粉',13104],[13075,'大葱',15637],[13077,'热带兰(石斛兰)',13302],[13079,'猪心',13310],[13076,'猕猴桃',13201],[13080,'鲈鱼',13151],[13073,'S33(油葵)',15060703],[13076,'白桃',15052348],[13075,'大蒜',13520],[13073,'高粱',15052308],[13073,'黑中片籽瓜子',15060735],[13076,'红马奶葡萄干',15060784],[13079,'基础母牛(500斤左右)',15060767],[13076,'金丝枣',15052307],[13076,'菱角',15060639],[13076,'龙眼(储良)',15059625],[13076,'龙眼(石硖)',15059632],[13076,'绿马奶葡萄干',15060783],[13079,'麻花公鸡',15058263],[13077,'满天星',13305],[13076,'芒果(红象牙9号)',15052357],[13076,'芒果(农院3号)',15052363],[13076,'芒果(台农一号)',15052367],[13080,'泥鳅',13135],[13073,'西葫芦白瓜籽(炒货)',15060369],[13080,'小黄鱼',15011220],[13073,'玉米',13086],[13080,'章鱼',15052322],[13080,'沼虾',15002873],[13079,'猪肝',13312],[13073,'芸豆',15060184],[13076,'柚',13197],[13075,'白萝卜',20408],[13080,'大带鱼',13124],[13073,'大米',13084],[13076,'脐橙',13150],[13077,'情人草',13309],[13079,'猪肚',13313],[13073,'花生油',13094],[13080,'人工甲鱼',13179],[13075,'生姜',15641],[13077,'勿忘我',13311],[13076,'香梨',13133],[13079,'猪后腿肌肉',13296],[13075,'葱头',15638],[13076,'红提子',13244],[13077,'红掌',13315],[13079,'三黄公鸡',15092423],[13079,'三黄鸡',13328],[13073,'香油',13113],[13080,'养殖鲶鱼',13140],[13075,'菜苔',8753469],[13080,'大黄鱼',13129],[13079,'活鸭',13261],[13077,'马蹄莲',13318],[13076,'芒果',13228],[13073,'特一粉',13108],[13075,'菜花',13514],[13079,'肥膘',13298],[13077,'鹤望兰',13321],[13073,'花生仁',13125],[13076,'龙眼(桂圆)',13226],[13080,'马鲅鱼',15052298],[13080,'小带鱼',13127],[13075,'胡萝卜',13512],[13077,'蛇鞭菊',13324],[13076,'桃子',13206],[13080,'小黄花鱼',13713],[13079,'猪前腿肌肉',13293],[13073,'籼米(晚籼米)',8754660],[13076,'草莓',13167],[13077,'观赏向日葵',13327],[13073,'花生',13122],[13080,'牛蛙',13168],[13075,'香菜',13504],[13079,'猪肺',13314],[13075,'冬瓜',15643],[13076,'甘蔗',13224],[13080,'基围虾',13189],[13077,'睡莲',13330],[13079,'猪大排肌肉',13294],[13073,'棕榈油',13115],[13076,'椪柑',13155],[13080,'草鱼',13093],[13075,'豆角',13510],[13073,'豆油',13090],[13077,'富贵竹',13334],[13076,'广柑',15002905],[13076,'芦柑',13153],[13079,'猪大肠',13317],[13075,'菠菜',13508],[13073,'菜油',13088],[13076,'金龙芒',15092406],[13077,'九里香',13338],[13076,'芒果(农院5号)',15092392],[0,'畜产品',13079],[13076,'雪梨',13123],[13079,'猪颈背肌肉',13289],[13080,'鲫鱼',13117],[13076,'红枣',13185],[13077,'山茜',13341],[13075,'蒜薹',13517],[13073,'特二粉',13111],[13079,'猪肾',13316],[13080,'鲢鱼',13089],[13073,'粳米',13085],[13079,'老母鸡',13329],[13080,'罗非鱼',13146],[13077,'肾蕨',13342],[13076,'香瓜',13164],[13075,'油菜',20416],[13079,'活鹅',8754641],[13080,'鲤鱼',13091],[13073,'糯米',8754700],[13076,'山竹',13260],[13075,'洋白菜',13511],[13077,'针葵叶',13346],[13080,'大平鱼',13131],[13077,'米兰',13350],[13076,'酥梨',13130],[13075,'西葫芦',13366],[13079,'仔猪',13253],[13073,'籼米',13083],[13076,'核桃',13176],[13077,'黄小鸟',13354],[13079,'活兔',13266],[13080,'活鳜鱼',13147],[13073,'葵花籽',8756521],[13075,'生菜',13495],[13073,'黑大片葵花籽',8756539],[13075,'莲藕',13503],[13079,'毛猪',13250],[13076,'柿子',13192],[13077,'文心兰(小)',13357],[13080,'小平鱼',13132],[13080,'白鳝鱼',13156],[13079,'柴鸡',13259],[13077,'黄樱',13358],[13076,'蛇果',13236],[13073,'晚籼稻',9060839],[13075,'莴笋',15642],[13080,'对虾',13121],[13077,'凤尾',13359],[13079,'黄牛',13304],[13075,'绿尖椒',15640],[13076,'油桃',13215],[13073,'早籼稻',9060841],[13080,'草虾',13191],[13079,'肥猪',13255],[13077,'桔梗',13361],[13075,'苦瓜',13499],[13076,'柠檬',13246],[13073,'芝麻(白芝麻)',9060826],[13076,'黄河蜜',15060243],[13079,'黄花母鸡',15092420],[13077,'龙柳',13362],[13075,'南瓜',13519],[13079,'蛇',15060257],[13076,'石榴',13230],[0,'水产品',13080],[13080,'梭子蟹',13175],[13075,'条形辣椒干(二荆条)',15060812],[13075,'条形辣椒干(小米椒)',15060815],[13075,'圆形辣椒干(草莓椒)',15060819],[13075,'圆形辣椒干(子弹头)',15060821],[13079,'猪小肠',13319],[13080,'虹鳟鱼',13149],[13076,'玫瑰香葡萄',13143],[13079,'山羊',13268],[13075,'香菇',13365],[13079,'红皮鸡蛋',13263],[13080,'扇贝',13165],[13075,'小白菜',13370],[13076,'伊丽沙白瓜',13158],[13075,'平菇',13217],[13076,'甜橙',13100],[13079,'猪皮',8754625],[13080,'蛏子',13204],[13079,'白皮鸡蛋',13264],[13080,'蛤蜊',13200],[13076,'国光苹果',13092],[13075,'丝瓜',13498],[13080,'澳洲龙虾',13196],[13079,'绵羊',13308],[13076,'青提子',13241],[13075,'西兰花',13497],[13076,'马奶葡萄',13145],[13075,'山药',13214],[13080,'野生甲鱼',13182],[13079,'育肥牛',13307],[13080,'海参',13159],[13076,'荔枝',13194],[13076,'荔枝(白腊)',15002887],[13076,'荔枝(桂味)',15002889],[13076,'荔枝(黑叶)',15002886],[13076,'荔枝(妃子笑)',8754866],[13079,'水牛',13306],[13075,'茼蒿',13225],[13079,'驴肉',13239],[13076,'山楂',13173],[13080,'石斑鱼',13152],[13075,'西洋芹',13374],[13076,'板栗',13180],[13080,'青蟹',13177],[13079,'肉羊',13351],[13075,'蒜苗',13518],[0,'粮油',13073],[13079,'肉牛',13349],[13075,'小葱',13367],[13080,'野生鲶鱼',13141],[13076,'樱桃',13169],[13080,'海鳗',13160],[13076,'红毛丹',13249],[13079,'活驴',13343],[13075,'芋头',13491],[13080,'花鲢活鱼',8754743],[13079,'肉马',13337],[13076,'杏子',13220],[13075,'油麦菜',13496],[13075,'红椒',13223],[13080,'江蟹',13172],[13076,'青苹果',13238],[13079,'肉鸡苗(只)',13326],[13080,'海蛎',13202],[13076,'黄元帅苹果',13114],[13079,'骡子',13332],[13075,'豇豆',13368],[13080,'鲍鱼',13186],[13076,'布朗',13258],[13079,'耕骡',13333],[13075,'红萝卜',13208],[13079,'耕马',13339],[13075,'空心菜',13494],[13076,'李子',13221],[13080,'乌龟',13183],[13079,'耕驴',13344],[13075,'荷兰豆',13486],[13076,'人参果',13256],[13080,'田鸡',13170],[13079,'鸡苗(只)',13303],[13080,'加吉鱼',13154],[13075,'金针菇',13218],[13076,'杨桃',13252],[13079,'黄花公鸡(只)',13353],[13075,'韭黄',13516],[13076,'苹果梨',13120],[13080,'鲅鱼',8754735],[13076,'大枣',15092411],[13076,'丰水梨',13138],[0,'果品',13076],[13076,'乔纳金苹果',15002896],[13080,'肉蟹',13171],[13079,'猪皮(张)',13320],[13075,'茴香',15639],[13076,'红星苹果',13109],[13075,'黄豆芽',13231],[13079,'役马',13336],[13080,'紫菜',13209],[13075,'长茄子',13487],[13076,'黄香蕉苹果',13112],[13079,'驴板肠',13347],[13080,'美洲龙虾',13198],[13075,'毛豆',13493],[13079,'山羯羊',13270],[13076,'椰子',13188],[13080,'鲨鱼',13212],[13075,'绿豆芽',13242],[13079,'山母羊',13286],[13080,'土虾',13193],[13076,'蟠桃',13210],[13080,'淡菜(鲜)',13203],[13076,'冬枣',22216],[13075,'尖椒',13489],[13079,'驴皮(张)',13345],[13075,'红尖椒',13490],[13076,'葡萄干(通货)',8754795],[13079,'鸭苗(只)',13301],[13080,'野生大黄鱼',13711],[13075,'茭白',13501],[13080,'鳗鱼干',13207],[13076,'麒麟西瓜',8754813],[13076,'白梨',13128],[13080,'深水网箱大黄鱼',13712],[13075,'圆茄子',13488],[13080,'真鲷',13163],[13075,'瓠子',13222],[13075,'佛手瓜',13211],[0,'蔬菜',13075],[13076,'杨梅',13136],[13080,'鮸鱼',13157],[13075,'木耳菜',13513],[13076,'秦冠苹果',13110],[13075,'樱桃西红柿',20415],[13076,'枇杷',13267],[13076,'特小凤西瓜',8754804],[13075,'苋菜',13229],[13076,'黑美人西瓜',8754833],[13075,'青冬瓜',13484],[13075,'韭苔',13372],[13076,'网纹瓜',8754773],[13076,'常山胡柚',13116],[13075,'韭菜花',13371],[13075,'鸡腿菇',13184],[13076,'沙田柚',20421],[13076,'嘎拉苹果',8754842],[13075,'芥菜',13373],[13076,'红香蕉苹果',8754761],[13075,'青笋',15644],[13075,'水萝卜',20412],[13076,'甜瓜',8754856],[13075,'菜瓜',13500],[13076,'早春红玉瓜',8754776],[13076,'龙眼葡萄',13142],[13075,'香椿',13483],[13076,'雪莲果',8754784],[13075,'荸荠',13502],[13075,'慈菇',13219],[13076,'京欣西瓜',8754822],[13075,'黑木耳',13174],[13076,'葡萄干(特级)',8754791],[13076,'象牙芒',13148],[13075,'玉米棒',18501],[13075,'良薯',20419],[13076,'砂糖橘',8756564],[13075,'茶树菇',13187],[13076,'华兰氏瓜',13161],[13075,'草菇',13199],[13076,'黄金瓜',8754770],[13075,'光皮黄瓜',13485],[13076,'年桔',8756566],[13075,'冬笋',15646],[13076,'芒果(金煌芒)',8754876],[13076,'白糖罐甜瓜',8754846],[13075,'辣椒干',13227],[13076,'红肖梨',13126],[13075,'银耳',13162],[13075,'杏鲍菇',13195],[13076,'芒果(象芽22号)',13262],[13075,'竹笋',15645],[13075,'白灵菇',13181],[13076,'石榴(大籽石榴)',13234],[13076,'芒果(红象芽9号)',20427],[13075,'豌豆',8754028],[13075,'凤尾菇',13178],[13076,'干枣',22219],[13075,'豌豆尖',8753869],[13076,'鲜枣',22215],[13075,'莲蓬',15060236],[13076,'葡萄干(二级)',9060834],[13075,'折耳根',8753866],[13075,'福鼎芋',13492],[13076,'葡萄干(一级)',9060833],[13075,'猴头菇',13190],[13075,'毛木耳',13166],[13075,'菜用仙人掌',13364],[13075,'枸杞二级',13205],[13075,'菜薹',20420],[13075,'白蒜5.0公分',8754211],[13075,'红蒜5.0公分',8754197],[13075,'蘑菇',16027048],[13075,'白蒜6.0公分',8754222],[13075,'马蹄',16026976],[13075,'红蒜6.0公分',9060807],[13075,'心里美萝卜',16007742],[13075,'萝卜丝',20428],[13075,'枸杞一级',9060853],[13073,'白芝麻',16007828],[13080,'大黄花鱼',16007643],[13076,'海棠果',16007932],[13076,'花盖梨',16026921],[13076,'菱枣',16007602],[13076,'木瓜',16007628],[13076,'葡萄',16007712],[13076,'青枣',16007579],[13175,'梭子蟹（公蟹）',6402806],[13175,'梭子蟹（母蟹）',6402802],[13076,'香水梨',16007912],[13080,'鳊鱼',16026950],[]]

def download(url, num_retries=2, user_agent='wswp', proxies=None):
    #print('Downloading:', url)
    headers = {'User-Agent': user_agent,'Referer':'http://nc.mofcom.gov.cn/channel/jghq2017/index.shtml'}
    try:
        resp = requests.get(url, headers=headers, proxies=proxies)
        resp.encoding = "gbk"
        html = resp.text
        if resp.status_code >= 400:
            print('Download error:', resp.text)
            html = None
            if num_retries and 500 <= resp.status_code < 600:
                # recursively retry 5xx HTTP errors
                return download(url, num_retries - 1)
    except requests.exceptions.RequestException as e:
        print('Download error:', e)
        html = None
    return html

db = pymysql.connect("localhost","root","tangning","jdbc" )
cursor = db.cursor()
sql="insert into t_gov_mofcom(date,class,product,price,unit,market) values(%s,%s,%s,%s, %s, %s)"

def craw(url,starttime,endtime):
    #实际分类信息
    classlist = {
        13079:"畜产品",
        13080:"水产品",
        13073:"粮油",
        13076:"果品",
        13075:"蔬菜"
        }
    for product in ary_base_market:
        try:
            page = url.format(product[0],product[2],starttime,endtime,1)
            name = product[1]
            classname = classlist[product[0]]

            htmls = download(page,user_agent='buhaoyisi')
            soup = BeautifulSoup(htmls,'html5lib')
            #页数
            pageCount = re.search('v_PageCount = ([0-9]+)',str(soup)).group(1)
            pageCount =  int(pageCount)
            for i in range(pageCount):
                link = url.format(product[0],product[2],starttime,endtime,i+1)
                htmls = download(link,user_agent='buhaoyisi')
                #睡眠两秒(不然gg)
                time.sleep(2)
                soup = BeautifulSoup(htmls,'html5lib')
                table = soup.find('table',attrs={'class':'table-01 mt30'})
                trs = table.find_all('tr')
                j = 0
                for tr in trs:
                    if j == 0:
                        j = j + 1
                        continue
                    tds  = tr.find_all('td')
                    #日期和单位
                    info = re.search(r'([0-9]+\.?[0-9]*)([^0-9]+)',tds[2].text.strip())
                    price = info.group(1)
                    unit = info.group(2)
                    #存入数据库
                    #print(tds[0].text,tds[1].text,price,unit,tds[3].text)
                    cursor.execute(sql,(tds[0].text,classname,tds[1].text,price,unit,tds[3].text.strip()))
                db.commit()
        except:
            continue

#起始日期
starttime = "2019-6-20"
#结束日期
endtime = "2019-6-30"
url="http://nc.mofcom.gov.cn/channel/jghq2017/price_list.shtml?par_craft_index={}&craft_index={}&par_p_index=&p_index=&startTime={}&endTime={}&page={}"
craw(url,starttime,endtime)
db.close()
